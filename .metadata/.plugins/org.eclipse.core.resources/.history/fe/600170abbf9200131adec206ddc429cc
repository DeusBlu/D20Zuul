import java.util.Stack;
/**
 * Used for the battle, loads 2 parties (player and monster) and uses a combat object to simulate
 * the actual battle
 * 
 * @author (DeusBlu) 
 * @version (0.1_7)
 */
public class Encounter
{
    private Party players;
    private Party opponents;
    private Combat combat;
    private Parser parser;
    private Stack<Entity> initiative;
    private Initiative init;
    private CombatUI ui;
    /**
     * default constructor for class Encounter
     */
    public Encounter()
    {
        players = new Party();
        opponents = new Party();
        combat = new Combat();
        parser = new Parser();
        initiative = new Stack<Entity>();
        ui = new CombatUI();
    }
    
    /**
     * Created the encounter and loads the parties for the encounter/initializes the Combat object
     * @param Party - the players party
     * @param Party - the part of monsters to fight
     */
    public Encounter(Party players, Party opponents)
    {
        setPlayers(players);
        setMonsters(opponents);
        combat = new Combat();
        parser = new Parser();
        initiative = new Stack<Entity>();
        ui = new CombatUI(players.getPlayers());
    }
    
    /**
     * the main combat method
     */
    public void fight()
    {
        boolean combatDone = false;
        System.out.print("Enemies Encountered!");
        while(!combatDone){
        	initiative = new Initiative().pcInit(players, opponents);
        	while(!initiative.isEmpty()){
        		if(initiative.peek().isDead()){
        			initiative.pop();
        		}
        		else{
        			takeTurn(initiative.pop());
        		}
        	}
        	if(players.isDefeated() || opponents.isDefeated()){
        		combatDone = true;
        	}
        }
    }
    
    /**
     * makes the entity take turn
     * @param takingTurn
     */
    private void takeTurn(Entity takingTurn)
    {
    	if(takingTurn instanceof Player){
    		boolean turnDone = false;
    		while(!turnDone){
    			Command command = parser.combatCommand();
    			turnDone = processCommand(command, ((Player)takingTurn));
    		}
    	}
    	else{
    		combat.attack(takingTurn, ui.attackWho());
    	}
    }
    
    /**
     * Given a command, process (that is: execute) the command.
     * @param command The command to be processed.
     * @return true If the command ends the game, false otherwise.
     */
    private boolean processCommand(Command command, Player player) 
    {
    	boolean turnDone = false;
        while(command.isUnknown()) {
            System.out.println("I don't know what you mean...");
            command = parser.combatCommand();
        }
        
        String commandWord = command.getCommandWord();
        if (commandWord.equals("help")){
            printHelp();
        }
        else if (commandWord.equals("status")){
            printStatus();
        }
        else if (commandWord.equals("equip")){
        	
            turnDone = true;
        }
        else if (commandWord.equals("attack")){
            turnDone = true;
        }
        else if(commandWord.equals("run")){
            turnDone = true;
        }
        return turnDone;
    }
    
    /**
     * loads the players party making sure that it is not a null object or an empty party
     * @param Party - the party of players
     */
    private void setPlayers(Party party)
    {
        if(party != null && !party.isEmpty()){
            players = party;
        }
    }
    
    /**
     * loads the monsters party making sure that it is not a null object or an empty party
     * @param Party - the monsters party
     */
    private void setMonsters(Party party)
    {
        if(party != null && !party.isEmpty()){
            opponents = party;
        }
    }
    
    /**
     * prints the help menu for combat
     */
    private void printHelp()
    {
        System.out.println("Combat Commands: ");
        System.out.println("attack run equip status");
    }
    
    /**
     * prints the status of the battle
     */
    private void printStatus()
    {
        System.out.println("Remaining Monsters:");
        System.out.println("-------------------------------");
        opponents.shortStatus();;
        System.out.println();
        System.out.println("Party Status:");
        System.out.println("-------------------------------");
        players.shortStatus();
    }
}
